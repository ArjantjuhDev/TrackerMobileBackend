<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Login TrackerMobile</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
    body { font-family: 'Inter', Arial, sans-serif; background: #181a20; color: #e0e0e0; margin: 0; }
    .login-box { background: #23263a; padding: 40px 32px; margin: 80px auto; width: 340px; border-radius: 16px; box-shadow: 0 4px 24px #0008; border: 1px solid #2c2f3c; animation: fadeIn 0.7s; display: flex; flex-direction: column; align-items: center; }
    h2 { text-align: center; color: #fff; text-shadow: 0 2px 8px #0006; font-size: 2em; margin-bottom: 18px; }
    input[type=text], input[type=password], input[type=number] { width: 100%; padding: 12px; margin: 10px 0 20px; border: 1px solid #444; border-radius: 8px; background: #181a20; color: #e0e0e0; font-size: 1em; transition: border 0.2s; }
    input:focus { border: 1.5px solid #1976d2; background: #23263a; }
    button { width: 100%; padding: 12px; background: linear-gradient(90deg,#1976d2,#0d47a1); color: #fff; border: none; border-radius: 8px; font-size: 1.1em; font-weight: bold; box-shadow: 0 2px 12px #0004; transition: background 0.2s, transform 0.2s; }
    button:hover { filter: brightness(1.15); transform: translateY(-2px); }
    .error { color: #d32f2f; text-align: center; margin-bottom: 12px; font-weight: bold; font-size: 1em; }
    .success { color: #388e3c; text-align: center; margin-bottom: 12px; font-weight: bold; font-size: 1em; }
    @media (max-width: 500px) { .login-box { width: 98vw; padding: 24px 8px; margin: 30px auto; } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        #map { height: 300px; width: 100%; margin-bottom: 1em; }
        .dashboard-box { background: #23263a; padding: 40px 32px; margin: 40px auto; width: 340px; border-radius: 16px; box-shadow: 0 4px 24px #0008; border: 1px solid #2c2f3c; animation: fadeIn 0.7s; display: flex; flex-direction: column; align-items: center; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 18px; }
        .dashboard-header h2 { margin: 0; color: #fff; text-shadow: 0 2px 8px #0006; font-size: 2em; }
        .dashboard-logout { background: linear-gradient(90deg,#888,#444); color: #fff; border: none; border-radius: 8px; font-size: 1em; font-weight: bold; padding: 8px 18px; box-shadow: 0 2px 12px #0004; margin-left: 12px; cursor: pointer; }
        .dashboard-logout:hover { filter: brightness(1.15); transform: translateY(-2px); }
        .dashboard-section { width: 100%; margin-bottom: 18px; }
        .dashboard-section h3 { color: #fff; margin-bottom: 8px; }
        .dashboard-section button, .dashboard-section input { margin-bottom: 8px; }
        @media (max-width: 500px) { .dashboard-box { width: 98vw; padding: 24px 8px; margin: 30px auto; } }
    </style>
</head>
<body>

<div id="loginScreen" style="display:none;">
    <div class="login-box">
        <h2>Login</h2>
        <input type="password" id="loginPassword" placeholder="Voer dashboard wachtwoord in" />
        <button onclick="doLogin()">Login</button>
        <div id="loginError" class="error"></div>
    </div>
</div>


<div id="dashboardScreen" style="display:none;">
    <div class="dashboard-box">
        <div class="dashboard-header">
            <h2>TrackerMobile Dashboard</h2>
            <button class="dashboard-logout" onclick="doLogout()">Logout</button>
        </div>
        <div class="dashboard-section">
                    <button onclick="fetchLocation()">Ververs</button>
                    <div id="locationText">Laden...</div>
                    <div id="devicesList">Laden...</div>
                    <div id="pendingList" style="margin-top:18px;"></div>
                    <div id="historyList" style="margin-top:18px;"></div>
                    <pre id="debugJson" style="background:#23263a;color:#fff;padding:8px;border-radius:6px;max-height:300px;overflow:auto;margin-top:10px;"></pre>
                    <div id="selectedDeviceInfo" style="margin-top:10px;color:#388e3c;"></div>
                    <div id="fetchError" style="color:red;margin-bottom:8px;"></div>
                    <div id="map"></div>
                    <div id="pairingSection" style="margin-top:24px;">
                        <h3>Toestel koppelen</h3>
                        <input type="text" id="pairCodeInput" placeholder="Voer koppelcode van toestel in" maxlength="6" style="width:100%;margin-bottom:8px;" />
                        <button onclick="pairDevice()">Koppel toestel</button>
                        <div id="pairingStatus" class="success"></div>
                    </div>
        </div>
        <div class="dashboard-section">
            <h3>Beveiliging</h3>
            <button onclick="requestLock()">Telefoon vergrendelen</button>
            <button onclick="resetLock()" style="margin-left:8px;">Unlock reset</button>
            <div id="lockStatus"></div>
        </div>
        <div class="dashboard-section">
            <h3>Formatteren</h3>
            <button onclick="requestWipe()">Telefoon wissen</button>
            <input type="password" id="wipePassword" placeholder="Wachtwoord voor wissen" />
            <div id="wipeStatus"></div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<!-- QR script verwijderd -->
<script>
// Pair device instantly using code from phone
function pairDevice() {
    const code = document.getElementById('pairCodeInput').value.trim();
    if (code.length !== 6 || !/^[0-9]{6}$/.test(code)) {
        document.getElementById('pairingStatus').textContent = 'Voer een geldige 6-cijferige code in.';
        document.getElementById('pairingStatus').className = 'error';
        return;
    }
    fetch(`${API_URL}/pair_device`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-API-Key': API_KEY
        },
        body: JSON.stringify({ code })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('pairingStatus').textContent = 'Toestel succesvol gekoppeld!';
            document.getElementById('pairingStatus').className = 'success';
            fetchLocation();
        } else {
            document.getElementById('pairingStatus').textContent = 'Koppeling mislukt: ' + (data.error || 'Onbekende fout');
            document.getElementById('pairingStatus').className = 'error';
        }
    })
    .catch(() => {
        document.getElementById('pairingStatus').textContent = 'Fout bij koppelen!';
        document.getElementById('pairingStatus').className = 'error';
    });
}
// --- Login/logout logic ---
const DASHBOARD_PASSWORD = "supergeheimwachtwoord"; // Zet hier je dashboard wachtwoord
function isLoggedIn() {
    return localStorage.getItem("dashboard_logged_in") === "true";
}
function doLogin() {
    const pwd = document.getElementById("loginPassword").value;
    if (pwd === DASHBOARD_PASSWORD) {
        localStorage.setItem("dashboard_logged_in", "true");
        document.getElementById("loginError").textContent = "";
        showDashboard();
    } else {
        document.getElementById("loginError").textContent = "Wachtwoord onjuist!";
    }
}
function doLogout() {
    localStorage.removeItem("dashboard_logged_in");
    showLogin();
}
function showLogin() {
    document.getElementById("loginScreen").style.display = "block";
    document.getElementById("dashboardScreen").style.display = "none";
}
function showDashboard() {
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("dashboardScreen").style.display = "block";
    fetchLocation();
}
window.onload = function() {
    if (isLoggedIn()) {
        showDashboard();
    } else {
        showLogin();
    }
    setInterval(function() {
        if (isLoggedIn()) fetchLocation();
    }, 5000);
};
// Cookie helpers
function setCookie(name, value, days) {
    let expires = "";
    if (days) {
        const date = new Date();
        date.setTime(date.getTime() + (days*24*60*60*1000));
        expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "")  + expires + "; path=/";
}
function getCookie(name) {
    const nameEQ = name + "=";
    const ca = document.cookie.split(';');
    for(let i=0;i < ca.length;i++) {
        let c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1,c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
    }
    return null;
}
function requestLock() {
    fetch(`${API_URL}/lock`, {
        method: 'POST',
        headers: { 'X-API-Key': API_KEY }
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('lockStatus').textContent = 'Telefoon is vergrendeld!';
    })
    .catch(() => {
        document.getElementById('lockStatus').textContent = 'Fout bij vergrendelen!';
    });
}

function resetLock() {
    fetch(`${API_URL}/lock/reset`, {
        method: 'POST',
        headers: { 'X-API-Key': API_KEY }
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('lockStatus').textContent = 'Lock is gereset!';
    })
    .catch(() => {
        document.getElementById('lockStatus').textContent = 'Fout bij resetten!';
    });
}
const API_KEY = 'jouw_geheime_api_key'; // Zet hier je API key
const API_URL = 'http://127.0.0.1:5000/api';
let map, marker;

function fetchLocation() {
    fetch(`${API_URL}/location`, { headers: { 'X-API-Key': API_KEY } })
        .then(function(r) {
            if (!r.ok) throw new Error('HTTP ' + r.status);
            return r.json();
        })
        .then(function(data) {
            document.getElementById('fetchError').textContent = '';
            document.getElementById('debugJson').textContent = JSON.stringify(data, null, 2);
            if (data.locations && data.locations.length > 0) {
                // Latest location per device
                const latestByDevice = {};
                // History: all device_ids and last seen
                const historyByDevice = {};
                for (const loc of data.locations) {
                    // Latest location
                    if (!latestByDevice[loc.device_id] || new Date(loc.timestamp) > new Date(latestByDevice[loc.device_id].timestamp)) {
                        latestByDevice[loc.device_id] = loc;
                    }
                    // History: last seen
                    if (!historyByDevice[loc.device_id] || new Date(loc.timestamp) > new Date(historyByDevice[loc.device_id])) {
                        historyByDevice[loc.device_id] = loc.timestamp;
                    }
                }
                // Devices list: only show verified devices
                const deviceEntries = Object.entries(latestByDevice);
                let verifiedDevices = [];
                if (deviceEntries.length > 0) {
                    let html = '<b>Toestellen:</b><ul>';
                    deviceEntries.forEach(function(entry) {
                        var device_id = entry[0];
                        var loc = entry[1];
                        // Only show devices that are NOT pending
                        if (!data.pending || !data.pending.some(p => p.device_id === device_id)) {
                            html += `<li><b>${device_id}</b>: Lat: ${loc.lat}, Lon: ${loc.lon} (${loc.timestamp})</li>`;
                            verifiedDevices.push({ device_id, lat: loc.lat, lon: loc.lon });
                        }
                    });
                    html += '</ul>';
                    document.getElementById('devicesList').innerHTML = html;
                } else {
                    document.getElementById('devicesList').textContent = 'Geen toestellen bekend.';
                }
                // Show all verified devices on the map
                if (verifiedDevices.length > 0) {
                    // Remove old map if exists
                    if (map) {
                        map.remove();
                        map = null;
                    }
                    // Center map to fit all devices
                    let bounds = [];
                    map = L.map('map');
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 19,
                    }).addTo(map);
                    verifiedDevices.forEach(function(dev) {
                        let marker = L.marker([dev.lat, dev.lon]).addTo(map);
                        marker.bindPopup(`<b>${dev.device_id}</b>`).openPopup();
                        bounds.push([dev.lat, dev.lon]);
                    });
                    if (bounds.length === 1) {
                        map.setView(bounds[0], 15);
                    } else {
                        map.fitBounds(bounds);
                    }
                } else {
                    if (map) {
                        map.remove();
                        map = null;
                    }
                }
                // Pending koppelingen: versimpeld
                if (data.pending && data.pending.length > 0) {
                    let pendHtml = '<b>Te koppelen toestellen:</b><ul>';
                    data.pending.forEach(function(device) {
                        pendHtml += `<li>${device.device_id} <button onclick=\"verifyDevice('${device.device_id}')\">Verifieer</button></li>`;
                    });
                    pendHtml += '</ul>';
                    document.getElementById('pendingList').innerHTML = pendHtml;
                } else {
                    document.getElementById('pendingList').textContent = '';
                }
                // History list
                const historyEntries = Object.entries(historyByDevice);
                if (historyEntries.length > 0) {
                    let histHtml = '<b>Toestel geschiedenis:</b><ul>';
                    historyEntries.forEach(function(entry) {
                        var device_id = entry[0];
                        var lastSeen = entry[1];
                        histHtml += `<li><b>${device_id}</b>: Laatst gezien: ${new Date(Number(lastSeen)).toLocaleString()}</li>`;
                    });
                    histHtml += '</ul>';
                    document.getElementById('historyList').innerHTML = histHtml;
                } else {
                    document.getElementById('historyList').textContent = '';
                }
// Verifieer device koppeling vanaf dashboard
function verifyDevice(device_id) {
    fetch(`${API_URL}/verify_device`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-API-Key': API_KEY
        },
        body: JSON.stringify({ device_id })
    })
    .then(r => r.json())
    .then(data => {
        alert('Device geverifieerd!');
        fetchLocation();
    })
    .catch(() => {
        alert('Fout bij verifiëren van device!');
    });
}
            } else {
                document.getElementById('devicesList').textContent = 'Geen toestellen bekend.';
            }
            if (data.wipe) {
                document.getElementById('wipeStatus').textContent = 'Wipe is aangevraagd!';
            } else {
                document.getElementById('wipeStatus').textContent = '';
            }
        })
        .catch(function(err) {
            document.getElementById('devicesList').textContent = 'Fout bij ophalen locatie.';
            document.getElementById('fetchError').textContent = 'Fout: ' + err.message;
        });
}

// QR functie en referenties verwijderd

function requestWipe() {
    const pwd = document.getElementById('wipePassword').value;
    if (pwd !== "WOVOM9brW1992!") {
        alert('Wachtwoord onjuist!');
        return;
    }
    if (!confirm('Weet je zeker dat je de telefoon wilt wissen?')) return;
    fetch(`${API_URL}/wipe`, {
        method: 'POST',
        headers: { 'X-API-Key': API_KEY }
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('wipeStatus').textContent = 'Wipe aangevraagd!';
    })
    .catch(() => {
        document.getElementById('wipeStatus').textContent = 'Fout bij wissen!';
    });
}

// window.onload replaced by login logic above
</script>
</body>
</html>
