<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Login TrackerMobile</title>
    <style>
    body { font-family: 'Inter', Arial, sans-serif; background: #181a20; color: #e0e0e0; margin: 0; }
    .container-desktop { max-width: 1100px; margin: 0 auto; padding: 0 32px; }
    .login-box { background: #23263a; padding: 48px 40px; margin: 80px auto; width: 420px; border-radius: 20px; box-shadow: 0 8px 40px #000a; border: 1px solid #2c2f3c; animation: fadeIn 0.7s; display: flex; flex-direction: column; align-items: center; }
    h2 { text-align: center; color: #fff; text-shadow: 0 2px 12px #0008; font-size: 2.2em; margin-bottom: 22px; letter-spacing: 0.5px; }
    input[type=text], input[type=password], input[type=number] { width: 100%; padding: 14px; margin: 12px 0 22px; border: 1.5px solid #444; border-radius: 10px; background: #181a20; color: #e0e0e0; font-size: 1.08em; transition: border 0.2s, box-shadow 0.2s; box-shadow: 0 2px 8px #0002; }
    input:focus { border: 2px solid #1976d2; background: #23263a; box-shadow: 0 2px 16px #1976d244; }
    button { width: 100%; padding: 14px; background: linear-gradient(90deg,#1976d2,#0d47a1); color: #fff; border: none; border-radius: 10px; font-size: 1.13em; font-weight: bold; box-shadow: 0 2px 16px #0006; transition: background 0.2s, transform 0.2s, box-shadow 0.2s; cursor: pointer; position: relative; }
    button:disabled { background: #444; color: #bbb; cursor: not-allowed; box-shadow: none; }
    button:hover:not(:disabled) { filter: brightness(1.18); transform: translateY(-2px) scale(1.03); box-shadow: 0 4px 24px #1976d244; }
    .error { color: #d32f2f; text-align: center; margin-bottom: 12px; font-weight: bold; font-size: 1em; background: #2c2f3c; border-radius: 6px; padding: 6px 0; }
    .success { color: #388e3c; text-align: center; margin-bottom: 12px; font-weight: bold; font-size: 1em; background: #23263a; border-radius: 6px; padding: 6px 0; }
    .card-block { background: #23263a; border-radius: 16px; box-shadow: 0 4px 24px #0006; padding: 28px 24px; margin-bottom: 28px; display: flex; flex-direction: column; align-items: center; min-width: 340px; }
    .material-icons { font-size: 1.7em; vertical-align: middle; }
        @media (max-width: 500px) { .login-box { width: 98vw; padding: 24px 8px; margin: 30px auto; } .card-block { padding: 14px 6px; min-width: unset; } }
        @media (min-width: 900px) {
            .container-desktop { display: flex; flex-direction: row; justify-content: center; align-items: flex-start; gap: 40px; }
            .login-box { width: 420px; margin: 80px 0; }
            .card-block { min-width: 340px; max-width: 420px; }
        }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container-desktop">
    <div class="login-box" id="loginBox">
        <h2>Login</h2>
        <form id="loginForm" style="width:100%;display:flex;flex-direction:column;align-items:center;">
            <input type="text" id="username" placeholder="Gebruikersnaam" required autofocus style="max-width:260px;">
            <input type="password" id="password" placeholder="Wachtwoord" required style="max-width:260px;">
            <div class="error" id="errorMsg" style="max-width:260px;"></div>
            <button type="submit" style="max-width:260px;">Inloggen</button>
        </form>
        <form id="totpSetupForm" style="width:100%;display:none;flex-direction:column;align-items:center;margin-top:18px;">
            <div id="totpQrBox" style="margin-bottom:12px;"></div>
            <button type="button" id="totpSetupNextBtn" style="max-width:180px;">QR gescand, ga verder</button>
        </form>
        <form id="totpForm" style="width:100%;display:none;flex-direction:column;align-items:center;margin-top:18px;">
            <input type="text" id="totpCode" placeholder="Google Authenticator code" maxlength="6" style="max-width:180px;">
            <div class="error" id="totpError" style="max-width:180px;"></div>
            <button type="submit" style="max-width:180px;">VerifiÃ«ren</button>
        </form>
    </div>
    <div class="login-box" id="logoutBox" style="display:none;flex-direction:column;align-items:center;">
        <h2>Welkom!</h2>
        <!-- Device Pairing Card -->
    <div class="card-block">
            <span style="font-size:1.2em;color:#1976d2;display:flex;align-items:center;margin-bottom:8px;"><span class="material-icons" style="margin-right:8px;">link</span>Toestel koppelen</span>
            <form id="pairForm" style="width:100%;display:flex;flex-direction:column;align-items:center;">
                <input type="text" id="pairCode" placeholder="Pair code (6 cijfers)" maxlength="6" style="max-width:180px;">
                <button type="submit" style="max-width:180px;"><span class="material-icons" style="vertical-align:middle;margin-right:6px;">add_link</span>Koppel toestel</button>
                <div class="success" id="pairSuccess" style="max-width:180px;"></div>
                <div class="error" id="pairError" style="max-width:180px;"></div>
            </form>
            <div id="deviceListBox" style="width:100%;margin-top:12px;display:none;flex-direction:column;align-items:center;">
                <label for="deviceSelector" style="color:#fff;margin-bottom:8px;display:flex;align-items:center;"><span class="material-icons" style="margin-right:6px;">devices</span>Gekoppelde toestellen:</label>
                <select id="deviceSelector" style="max-width:180px;margin-bottom:8px;"></select>
                <button id="removeDeviceBtn" style="max-width:180px;margin-bottom:8px;"><span class="material-icons" style="vertical-align:middle;margin-right:6px;">delete</span>Verwijder toestel</button>
                <button id="addDeviceBtn" style="max-width:180px;margin-bottom:8px;background:#388e3c;color:#fff;"><span class="material-icons" style="vertical-align:middle;margin-right:6px;">add</span>Voeg toestel toe</button>
            </div>
        </div>
        <!-- Remote Control Card -->
    <div id="remoteControlBox" class="card-block" style="display:none;">
            <span style="font-size:1.2em;color:#388e3c;display:flex;align-items:center;margin-bottom:8px;"><span class="material-icons" style="margin-right:8px;">security</span>Remote Control</span>
            <div id="deviceOfflineMsg" style="display:none;color:#d32f2f;font-weight:bold;margin-bottom:12px;"><span class="material-icons" style="vertical-align:middle;margin-right:6px;">power_off</span>Telefoon is uit</div>
            <button id="powerOnBtn" style="max-width:180px;margin-bottom:12px;" disabled title="Op afstand aanzetten is niet mogelijk op Android;"><span class="material-icons" style="vertical-align:middle;margin-right:6px;">power_settings_new</span>Aanzetten</button>
            <button id="lockBtn" style="max-width:180px;margin-bottom:12px;"><span class="material-icons" style="vertical-align:middle;margin-right:6px;">lock</span>Vergrendel toestel</button>
            <div id="unlockSection" style="display:none;flex-direction:column;align-items:center;margin-bottom:12px;">
                <input type="text" id="unlockCodeInput" placeholder="Ontgrendelcode" maxlength="8" style="max-width:140px;margin-bottom:8px;">
                <button id="unlockBtn" style="max-width:140px;"><span class="material-icons" style="vertical-align:middle;margin-right:6px;">lock_open</span>Ontgrendel toestel</button>
            </div>
            <button id="wipeBtn" style="max-width:180px;margin-bottom:12px;"><span class="material-icons" style="vertical-align:middle;margin-right:6px;">delete_forever</span>Wis toestel</button>
            <button id="screenshotBtn" style="max-width:180px;margin-bottom:12px;"><span class="material-icons" style="vertical-align:middle;margin-right:6px;">photo_camera</span>Live scherm</button>
            <div id="screenData" style="margin-top:12px;color:#e0e0e0;"></div>
        </div>
        <!-- Location Card -->
    <div id="locationBox" class="card-block" style="width:320px;">
            <span style="font-size:1.2em;color:#1976d2;display:flex;align-items:center;margin-bottom:8px;"><span class="material-icons" style="margin-right:8px;">location_on</span>Locatie</span>
            <div id="map" style="width:100%;height:220px;border-radius:8px;overflow:hidden;background:#23263a;"></div>
            <div id="locationText" style="margin-top:8px;color:#e0e0e0;"></div>
            <button id="shareLocationBtn" style="margin-top:10px;background:#1976d2;color:#fff;padding:10px 18px;border:none;border-radius:8px;font-weight:bold;display:flex;align-items:center;"><span class="material-icons" style="vertical-align:middle;margin-right:6px;">share_location</span>Deel met politie</button>
        </div>
    <button id="logoutBtn" style="max-width:260px;margin-top:18px;display:flex;align-items:center;"><span class="material-icons" style="vertical-align:middle;margin-right:6px;">logout</span>Uitloggen</button>
    <!-- Admin Card -->
    <div id="adminBox" class="card-block" style="width:340px;">
        <span style="font-size:1.2em;color:#d32f2f;display:flex;align-items:center;margin-bottom:8px;"><span class="material-icons" style="margin-right:8px;">admin_panel_settings</span>Admin: Accounts beheren</span>
        <div id="accountList" style="width:100%;margin-bottom:12px;"></div>
        <form id="addAccountForm" style="width:100%;display:flex;flex-direction:column;align-items:center;">
            <input type="text" id="newAccountUsername" placeholder="Gebruikersnaam" required style="max-width:180px;">
            <input type="password" id="newAccountPassword" placeholder="Wachtwoord" required style="max-width:180px;">
            <button type="submit" style="max-width:180px;margin-top:8px;"><span class="material-icons" style="vertical-align:middle;margin-right:6px;">person_add</span>Account toevoegen</button>
            <div class="success" id="addAccountSuccess" style="max-width:180px;"></div>
            <div class="error" id="addAccountError" style="max-width:180px;"></div>
        </form>
    </div>
        <div id="connectionStatus" style="margin-top:12px;font-size:0.95em;"></div>
    </div>
    </div>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    // === CONFIGUREER HIER DE BACKEND API URL ===
    const BACKEND_API_URL = 'https://tracker-mobile-backend.onrender.com/api';

    // JWT helpers
    function setJwtToken(token) {
        localStorage.setItem('jwtToken', token || '');
    }
    function getJwtToken() {
        return localStorage.getItem('jwtToken') || '';
    }
    function eraseJwtToken() {
        localStorage.removeItem('jwtToken');
    }

    // Admin: fetch and render accounts
    async function fetchAccounts() {
        try {
            const res = await fetch(`${BACKEND_API_URL}/admin/accounts`, {
                headers: { 'Authorization': 'Bearer ' + getJwtToken() }
            });
            const data = await res.json();
            if (data.success && Array.isArray(data.accounts)) {
                const list = document.getElementById('accountList');
                list.innerHTML = '';
                data.accounts.forEach(acc => {
                    const div = document.createElement('div');
                    div.style.display = 'flex';
                    div.style.justifyContent = 'space-between';
                    div.style.alignItems = 'center';
                    div.style.marginBottom = '6px';
                    div.innerHTML = `<span style='color:#fff;'>${acc.username}</span> <button style='background:#d32f2f;color:#fff;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;' onclick='deleteAccount(\"${acc.username}\")'><span class='material-icons' style='font-size:1em;vertical-align:middle;'>delete</span></button>`;
                    list.appendChild(div);
                });
            }
        } catch (err) {
            document.getElementById('accountList').innerHTML = '<span style="color:#d32f2f;">Kan accounts niet laden.</span>';
        }
    }
    async function deleteAccount(username) {
        if (!confirm('Account verwijderen: ' + username + '?')) return;
        try {
            const res = await fetch(`${BACKEND_API_URL}/admin/accounts/` + encodeURIComponent(username), {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + getJwtToken() }
            });
            const data = await res.json();
            if (data.success) {
                fetchAccounts();
            } else {
                alert('Verwijderen mislukt.');
            }
        } catch (err) {
            alert('Serverfout bij verwijderen.');
        }
    }
    document.getElementById('addAccountForm').onsubmit = async function(e) {
        e.preventDefault();
        const username = document.getElementById('newAccountUsername').value;
        const password = document.getElementById('newAccountPassword').value;
        document.getElementById('addAccountSuccess').textContent = '';
        document.getElementById('addAccountError').textContent = '';
        try {
            const res = await fetch(`${BACKEND_API_URL}/admin/accounts`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + getJwtToken()
                },
                body: JSON.stringify({ username, password })
            });
            const data = await res.json();
            if (data.success) {
                document.getElementById('addAccountSuccess').textContent = 'Account toegevoegd!';
                document.getElementById('addAccountError').textContent = '';
                document.getElementById('newAccountUsername').value = '';
                document.getElementById('newAccountPassword').value = '';
                fetchAccounts();
            } else {
                document.getElementById('addAccountError').textContent = data.error || 'Toevoegen mislukt.';
            }
        } catch (err) {
            document.getElementById('addAccountError').textContent = 'Serverfout: ' + err.message;
        }
    };
    // Fetch accounts on page load
    window.addEventListener('DOMContentLoaded', fetchAccounts);
    // Utility: show loading spinner on buttons
    function setButtonLoading(btn, loading) {
        if (loading) {
            btn.disabled = true;
            btn.innerHTML = '<span class="material-icons" style="vertical-align:middle;margin-right:6px;">hourglass_top</span>Bezig...';
        } else {
            btn.disabled = false;
            btn.innerHTML = btn.getAttribute('data-label') || btn.textContent;
        }
    }
    let unlockCode = null;
    // Cookie helpers
    function setCookie(name, value, days) {
        let expires = "";
        if (days) {
            const date = new Date();
            date.setTime(date.getTime() + (days*24*60*60*1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "")  + expires + "; path=/";
    }
    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i=0;i < ca.length;i++) {
            let c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1,c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
        }
        return null;
    }
    function eraseCookie(name) {
        document.cookie = name+'=; Max-Age=-99999999; path=/';
    }

    // UI logic
    function showLogin() {
        document.getElementById('loginBox').style.display = 'flex';
        document.getElementById('logoutBox').style.display = 'none';
        // Do NOT clear paired devices on logout
    }
    function showLogout() {
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('logoutBox').style.display = 'flex';
    }

    // Multi-device helpers
    function getPairedDevices() {
        const json = localStorage.getItem('pairedDevices');
        return json ? JSON.parse(json) : [];
    }
    function setPairedDevices(devices) {
        localStorage.setItem('pairedDevices', JSON.stringify(devices));
    }

    // On page load, check login state and paired devices, and assign event handlers
    window.onload = function() {
        const pairedDevices = getPairedDevices();
        if (getCookie('loggedIn') === 'true') {
            showLogout();
            if (pairedDevices.length > 0) {
                document.getElementById('deviceListBox').style.display = 'flex';
                populateDeviceSelector(pairedDevices);
                document.getElementById('remoteControlBox').style.display = 'flex';
                joinDeviceRoom(pairedDevices[0].code);
                document.getElementById('pairForm').style.display = 'none';
            } else {
                document.getElementById('pairForm').style.display = 'flex';
                document.getElementById('deviceListBox').style.display = 'none';
                document.getElementById('remoteControlBox').style.display = 'none';
            }
        } else {
            showLogin();
            if (pairedDevices.length > 0) {
                document.getElementById('deviceListBox').style.display = 'flex';
                populateDeviceSelector(pairedDevices);
            } else {
                document.getElementById('deviceListBox').style.display = 'none';
            }
            document.getElementById('pairForm').style.display = 'none';
            document.getElementById('remoteControlBox').style.display = 'none';
        }
        // Hide pairing form by default, show when addDeviceBtn is clicked
        document.getElementById('addDeviceBtn').onclick = function() {
            document.getElementById('pairForm').style.display = 'flex';
            document.getElementById('pairSuccess').textContent = '';
            document.getElementById('pairError').textContent = '';
            document.getElementById('pairCode').value = '';
        };

        // Move all event handler assignments here
        document.getElementById('loginForm').onsubmit = loginFormHandler;
        document.getElementById('totpSetupNextBtn').onclick = totpSetupNextHandler;
        document.getElementById('totpForm').onsubmit = totpFormHandler;
        document.getElementById('addAccountForm').onsubmit = addAccountFormHandler;
        document.getElementById('deviceSelector').onchange = deviceSelectorHandler;
        document.getElementById('removeDeviceBtn').onclick = removeDeviceBtnHandler;
        document.getElementById('logoutBtn').onclick = logoutBtnHandler;
        document.getElementById('pairForm').onsubmit = pairFormHandler;
    };

    // Move handler functions out for assignment
    function loginFormHandler(e) { /* ...existing code... */ }
    function totpSetupNextHandler(e) { /* ...existing code... */ }
    function totpFormHandler(e) { /* ...existing code... */ }
    function addAccountFormHandler(e) { /* ...existing code... */ }
    function deviceSelectorHandler(e) { /* ...existing code... */ }
    function removeDeviceBtnHandler(e) { /* ...existing code... */ }
    function logoutBtnHandler(e) { /* ...existing code... */ }
    function pairFormHandler(e) { /* ...existing code... */ }

    function populateDeviceSelector(devices) {
        const selector = document.getElementById('deviceSelector');
        selector.innerHTML = '';
        devices.forEach((dev, idx) => {
            const opt = document.createElement('option');
            opt.value = dev.code;
            opt.textContent = dev.name ? dev.name + ' (' + dev.code + ')' : dev.code;
            selector.appendChild(opt);
        });
    }

    // Login form handler
    // Eerst login, dan 2FA
    let pendingLogin = null;
    document.getElementById('loginForm').onsubmit = async function(e) {
        setButtonLoading(document.querySelector('#loginForm button'), true);
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        document.getElementById('errorMsg').textContent = '';
        if (username && password) {
            // Simpele demo: sla username op en ga naar TOTP setup
            pendingLogin = { username, password };
            // Vraag TOTP QR code aan
            try {
                const res = await fetch(`${BACKEND_API_URL}/totp_2fa/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                const data = await res.json();
                if (data.success && data.qr) {
                    setButtonLoading(document.querySelector('#loginForm button'), false);
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('totpSetupForm').style.display = 'flex';
                    document.getElementById('totpQrBox').innerHTML = `<img src='${data.qr}' style='max-width:180px;border-radius:8px;margin-bottom:8px;'><div style='color:#fff;font-size:0.95em;'>Scan deze QR met Google Authenticator</div>`;
                } else {
                    setButtonLoading(document.querySelector('#loginForm button'), false);
                    document.getElementById('errorMsg').textContent = 'Kon QR code niet genereren.';
                }
            } catch (err) {
                setButtonLoading(document.querySelector('#loginForm button'), false);
                document.getElementById('errorMsg').textContent = 'Serverfout: ' + err.message;
            }
        } else {
            setButtonLoading(document.querySelector('#loginForm button'), false);
            document.getElementById('errorMsg').textContent = 'Ongeldige gegevens';
        }
    };
    document.getElementById('totpSetupNextBtn').onclick = function() {
        document.getElementById('totpSetupForm').style.display = 'none';
        document.getElementById('totpForm').style.display = 'flex';
    };
    document.getElementById('totpForm').onsubmit = async function(e) {
        setButtonLoading(document.querySelector('#totpForm button'), true);
        e.preventDefault();
        const code = document.getElementById('totpCode').value;
        document.getElementById('totpError').textContent = '';
        if (!code || code.length !== 6) {
            document.getElementById('totpError').textContent = 'Voer een geldige 6-cijferige code in.';
            setButtonLoading(document.querySelector('#totpForm button'), false);
            return;
        }
        try {
            const res = await fetch(`${BACKEND_API_URL}/totp_2fa/verify`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: pendingLogin.username, token: code })
            });
            const data = await res.json();
            if (data.success) {
                setButtonLoading(document.querySelector('#totpForm button'), false);
                setCookie('loggedIn', 'true', 7); // 7 dagen ingelogd
                document.getElementById('totpError').textContent = '';
                // Store JWT if present
                if (data.token) setJwtToken(data.token);
                showLogout();
                document.getElementById('pairForm').style.display = 'flex';
                document.getElementById('remoteControlBox').style.display = 'none';
                checkConnection();
            } else {
                setButtonLoading(document.querySelector('#totpForm button'), false);
                document.getElementById('totpError').textContent = 'Ongeldige code.';
            }
        } catch (err) {
            setButtonLoading(document.querySelector('#totpForm button'), false);
            document.getElementById('totpError').textContent = 'Serverfout: ' + err.message;
        }
    };

    document.getElementById('twofaForm').onsubmit = async function(e) {
        setButtonLoading(document.querySelector('#twofaForm button'), true);
        e.preventDefault();
        const code = document.getElementById('twofaCode').value;
        document.getElementById('twofaError').textContent = '';
        if (!code || code.length !== 6) {
            document.getElementById('twofaError').textContent = 'Voer een geldige 6-cijferige code in.';
            return;
        }
        try {
            const res = await fetch(`${BACKEND_API_URL}/request_2fa/verify`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: 'arjan@radioredarrow.nl', code })
            });
            const data = await res.json();
            if (data.success) {
                setButtonLoading(document.querySelector('#twofaForm button'), false);
                setCookie('loggedIn', 'true', 7); // 7 dagen ingelogd
                document.getElementById('twofaError').textContent = '';
                showLogout();
                // Show pairing form after 2FA
                document.getElementById('pairForm').style.display = 'flex';
                document.getElementById('remoteControlBox').style.display = 'none';
                checkConnection();
            } else {
                setButtonLoading(document.querySelector('#twofaForm button'), false);
                document.getElementById('twofaError').textContent = 'Ongeldige code.';
            }
        } catch (err) {
            setButtonLoading(document.querySelector('#twofaForm button'), false);
            document.getElementById('twofaError').textContent = 'Serverfout: ' + err.message;
        }
    };

    // Logout button handler
    document.getElementById('logoutBtn').onclick = function() {
    eraseCookie('loggedIn');
    eraseJwtToken();
    showLogin();
    // Do NOT clear paired devices here
    };

    // Device pairing logic
    document.getElementById('pairForm').onsubmit = async function(e) {
        setButtonLoading(document.querySelector('#pairForm button'), true);
        e.preventDefault();
        const code = document.getElementById('pairCode').value;
        document.getElementById('pairSuccess').textContent = '';
        document.getElementById('pairError').textContent = '';
        if (!code || code.length !== 6) {
            document.getElementById('pairError').textContent = 'Voer een geldige 6-cijferige code in.';
            return;
        }
        try {
            const res = await fetch(`${BACKEND_API_URL}/pair_device`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code })
            });
            const data = await res.json();
            if (data.success) {
                setButtonLoading(document.querySelector('#pairForm button'), false);
                document.getElementById('pairSuccess').textContent = 'Toestel gekoppeld!';
                let pairedDevices = getPairedDevices();
                // Ask for device name
                let name = prompt('Naam voor toestel?', 'Android ' + (pairedDevices.length + 1));
                pairedDevices.push({ code, name });
                setPairedDevices(pairedDevices);
                populateDeviceSelector(pairedDevices);
                document.getElementById('pairForm').style.display = 'none';
                document.getElementById('deviceListBox').style.display = 'flex';
                document.getElementById('remoteControlBox').style.display = 'flex';
                joinDeviceRoom(code);
                // Hide unlock section and clear code after pairing
                document.getElementById('unlockSection').style.display = 'none';
                document.getElementById('unlockCodeInput').value = '';
                document.getElementById('unlockCodeInput').placeholder = 'Ontgrendelcode';
            } else {
                setButtonLoading(document.querySelector('#pairForm button'), false);
                document.getElementById('pairError').textContent = data.error || 'Koppeling mislukt.';
            }
        } catch (err) {
            setButtonLoading(document.querySelector('#pairForm button'), false);
            document.getElementById('pairError').textContent = 'Serverfout: ' + err.message;
        }
    };

    document.getElementById('deviceSelector').onchange = function() {
        const code = this.value;
        joinDeviceRoom(code);
    };

    document.getElementById('removeDeviceBtn').onclick = function() {
        let pairedDevices = getPairedDevices();
        const selector = document.getElementById('deviceSelector');
        const idx = selector.selectedIndex;
        if (idx >= 0) {
            pairedDevices.splice(idx, 1);
            setPairedDevices(pairedDevices);
            populateDeviceSelector(pairedDevices);
            if (pairedDevices.length > 0) {
                joinDeviceRoom(pairedDevices[0].code);
            } else {
                document.getElementById('deviceListBox').style.display = 'none';
                document.getElementById('remoteControlBox').style.display = 'none';
                document.getElementById('pairForm').style.display = 'flex';
            }
        }
    };

    // Socket.io connection
    let socket = null;
    // Use your Render backend websocket address below (replace with your actual Render URL)
    let socketServerUrl = "wss://tracker-mobile-backend.onrender.com";

    // Locatie op kaart en delen
    let lastLocation = null;
    function setupLocationListeners() {
        socket.on('location-update', (locObj) => {
            if (!locObj || !locObj.lat || !locObj.lon) return;
            lastLocation = locObj;
            document.getElementById('locationText').textContent = `Lat: ${locObj.lat}, Lon: ${locObj.lon}`;
            // Initialize map if not already
            if (!leafletMap) {
                leafletMap = L.map('map').setView([locObj.lat, locObj.lon], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(leafletMap);
                leafletMarker = L.marker([locObj.lat, locObj.lon]).addTo(leafletMap);
            } else {
                leafletMap.setView([locObj.lat, locObj.lon], 15);
                if (leafletMarker) {
                    leafletMarker.setLatLng([locObj.lat, locObj.lon]);
                } else {
                    leafletMarker = L.marker([locObj.lat, locObj.lon]).addTo(leafletMap);
                }
            }
        });
        document.getElementById('shareLocationBtn').onclick = function() {
            if (lastLocation) {
                const url = `https://maps.google.com/?q=${lastLocation.lat},${lastLocation.lon}`;
                navigator.clipboard.writeText(url);
                alert('Locatie is gekopieerd en kan gedeeld worden met de politie!');
            }
        };
    }

    function joinDeviceRoom(code) {
        if (!window.io) return;
        if (socket) socket.disconnect();
        try {
            socket = io(socketServerUrl, { transports: ['websocket'] });
            console.log('Socket.IO: created socket, joining room', code);
            socket.on('connect', () => {
                document.getElementById('connectionStatus').textContent = 'Verbinding maken...';
                document.getElementById('deviceOfflineMsg').style.display = 'none';
                document.getElementById('powerOnBtn').disabled = true;
                console.log('Socket.IO: connected, emitting join-room', code);
                socket.emit('join-room', code);
                requestPermissionsOnApp();
                setupLocationListeners();
            });
            socket.on('paired', () => {
                document.getElementById('connectionStatus').textContent = 'Verbonden met toestel (' + code + ')';
                document.getElementById('deviceOfflineMsg').style.display = 'none';
                document.getElementById('powerOnBtn').disabled = true;
                console.log('Socket.IO: received paired event');
            });
            socket.on('disconnect', () => {
                document.getElementById('connectionStatus').textContent = 'Telefoon is uit.';
                document.getElementById('deviceOfflineMsg').style.display = 'block';
                document.getElementById('powerOnBtn').disabled = true;
                console.log('Socket.IO: disconnected');
            });
            socket.on('connect_error', (err) => {
                document.getElementById('connectionStatus').textContent = 'Socket.io fout: ' + err.message;
                document.getElementById('deviceOfflineMsg').style.display = 'block';
                document.getElementById('powerOnBtn').disabled = true;
                console.log('Socket.IO: connect_error', err);
            });
            socket.on('user-joined', (id) => {
                document.getElementById('connectionStatus').textContent = 'Toestel verbonden: ' + id;
                document.getElementById('deviceOfflineMsg').style.display = 'none';
                document.getElementById('powerOnBtn').disabled = true;
                console.log('Socket.IO: user-joined', id);
            });
            socket.on('permissions-accepted', () => {
                document.getElementById('remoteControlBox').style.display = 'flex';
                document.getElementById('deviceOfflineMsg').style.display = 'none';
                document.getElementById('powerOnBtn').disabled = true;
                console.log('Socket.IO: permissions-accepted received');
            });
            socket.on('screen-data', (data) => {
                // Verwacht base64 PNG/JPEG string
                let img = document.createElement('img');
                img.src = 'data:image/png;base64,' + data;
                img.style.maxWidth = '320px';
                img.style.borderRadius = '8px';
                img.style.marginTop = '8px';
                let screenDataDiv = document.getElementById('screenData');
                screenDataDiv.innerHTML = '';
                screenDataDiv.appendChild(img);
                console.log('Socket.IO: screen-data received');
            });
        } catch (err) {
            document.getElementById('connectionStatus').textContent = 'Socket.io fout: ' + err.message;
            document.getElementById('deviceOfflineMsg').style.display = 'block';
            document.getElementById('powerOnBtn').disabled = true;
            console.log('Socket.IO: error', err);
        }
    }

    // Request permissions on app from website
    function requestPermissionsOnApp() {
        if (socket) socket.emit('request-permissions');
    }

    // Remote control knoppen
    document.getElementById('lockBtn').onclick = function() {
        if (unlockCode) return; // Prevent double lock
        unlockCode = Math.floor(100000 + Math.random() * 900000).toString();
        if (socket) socket.emit('lock-device', unlockCode);
        document.getElementById('unlockSection').style.display = 'flex';
        document.getElementById('wipeBtn').style.display = 'inline-block';
        document.getElementById('screenshotBtn').style.display = 'inline-block';
        document.getElementById('unlockCodeInput').placeholder = 'Code: ' + unlockCode;
    };
    document.getElementById('unlockBtn').onclick = function() {
        const code = document.getElementById('unlockCodeInput').value;
        if (socket && code) socket.emit('unlock-device', code);
        // Reset UI after unlock
        unlockCode = null;
        document.getElementById('unlockSection').style.display = 'none';
        document.getElementById('wipeBtn').style.display = 'none';
        document.getElementById('screenshotBtn').style.display = 'none';
        document.getElementById('unlockCodeInput').value = '';
        document.getElementById('unlockCodeInput').placeholder = 'Ontgrendelcode';
    };
    document.getElementById('wipeBtn').onclick = function() {
        if (socket) socket.emit('wipe-device');
    };
    document.getElementById('screenshotBtn').onclick = function() {
        if (socket) socket.emit('request-screenshot');
    };

    // Check backend connection
    async function checkConnection() {
        try {
            const res = await fetch(`${BACKEND_API_URL}/check_connection`);
            const data = await res.json();
            if (data.connected) {
                document.getElementById('connectionStatus').textContent = 'Backend verbinding OK.';
            } else {
                document.getElementById('connectionStatus').textContent = 'Backend niet bereikbaar.';
            }
        } catch (err) {
            document.getElementById('connectionStatus').textContent = 'Backend niet bereikbaar.';
        }
    }
    </script>
</body>
</html>

