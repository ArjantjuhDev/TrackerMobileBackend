<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <title>Login TrackerMobile</title>
    <style>
    body { font-family: 'Inter', Arial, sans-serif; background: #181a20; color: #e0e0e0; margin: 0; }
    .container-desktop { max-width: 1100px; margin: 0 auto; padding: 0 32px; }
    .login-box { background: #23263a; padding: 48px 40px; margin: 80px auto; width: 420px; border-radius: 20px; box-shadow: 0 8px 40px #000a; border: 1px solid #2c2f3c; animation: fadeIn 0.7s; display: flex; flex-direction: column; align-items: center; }
    h2 { text-align: center; color: #fff; text-shadow: 0 2px 12px #0008; font-size: 2.2em; margin-bottom: 22px; letter-spacing: 0.5px; }
    input[type=text], input[type=password], input[type=number] { width: 100%; padding: 14px; margin: 12px 0 22px; border: 1.5px solid #444; border-radius: 10px; background: #181a20; color: #e0e0e0; font-size: 1.08em; transition: border 0.2s, box-shadow 0.2s; box-shadow: 0 2px 8px #0002; }
    input:focus { border: 2px solid #1976d2; background: #23263a; box-shadow: 0 2px 16px #1976d244; }
    button { width: 100%; padding: 14px; background: linear-gradient(90deg,#1976d2,#0d47a1); color: #fff; border: none; border-radius: 10px; font-size: 1.13em; font-weight: bold; box-shadow: 0 2px 16px #0006; transition: background 0.2s, transform 0.2s, box-shadow 0.2s; cursor: pointer; position: relative; }
    button:disabled { background: #444; color: #bbb; cursor: not-allowed; box-shadow: none; }
    button:hover:not(:disabled) { filter: brightness(1.18); transform: translateY(-2px) scale(1.03); box-shadow: 0 4px 24px #1976d244; }
    .error { color: #d32f2f; text-align: center; margin-bottom: 12px; font-weight: bold; font-size: 1em; background: #2c2f3c; border-radius: 6px; padding: 6px 0; }
    .success { color: #388e3c; text-align: center; margin-bottom: 12px; font-weight: bold; font-size: 1em; background: #23263a; border-radius: 6px; padding: 6px 0; }
    .card-block { background: #23263a; border-radius: 16px; box-shadow: 0 4px 24px #0006; padding: 28px 24px; margin-bottom: 28px; display: flex; flex-direction: column; align-items: center; min-width: 340px; }
    .material-icons { font-size: 1.7em; vertical-align: middle; }
        @media (max-width: 500px) { .login-box { width: 98vw; padding: 24px 8px; margin: 30px auto; } .card-block { padding: 14px 6px; min-width: unset; } }
        @media (min-width: 900px) {
            .container-desktop { display: flex; flex-direction: row; justify-content: center; align-items: flex-start; gap: 40px; }
            .login-box { width: 420px; margin: 80px 0; }
            .card-block { min-width: 340px; max-width: 420px; }
        }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container-desktop">
        <div id="sidebar-index-container"></div>
        <div id="login-form-index-container"></div>
        <div id="device-list-container"></div>
        <div id="device-actions-container"></div>
        <!-- You can add more containers for other modular components as needed -->
        <div id="connectionStatus" style="margin-top:12px;font-size:0.95em;"></div>
    </div>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    // Dynamically import components and inject into containers
    async function importComponent(containerId, componentPath) {
        const container = document.getElementById(containerId);
        if (!container) return;
        try {
            const res = await fetch(componentPath);
            const html = await res.text();
            container.innerHTML = html;
        } catch (err) {
            container.innerHTML = `<div style='color:#d32f2f;'>Component ${componentPath} kon niet geladen worden.</div>`;
        }
    }

    // Load all components on page load
    function safeAttach(id, event, handler) {
        const el = document.getElementById(id);
        if (el) el[event] = handler;
    }
    window.onload = async function() {
        await importComponent('sidebar-index-container', 'components/SidebarIndex.html');
        await importComponent('login-form-index-container', 'components/LoginFormIndex.html');
        await importComponent('device-list-container', 'components/DeviceList.html');
        await importComponent('device-actions-container', 'components/DeviceActions.html');
        // Attach listeners safely
        safeAttach('loginForm', 'onsubmit', loginFormHandler);
        safeAttach('totpSetupNextBtn', 'onclick', totpSetupNextHandler);
        safeAttach('totpForm', 'onsubmit', totpFormHandler);
        safeAttach('deviceSelector', 'onchange', deviceSelectorHandler);
        safeAttach('removeDeviceBtn', 'onclick', removeDeviceBtnHandler);
        safeAttach('logoutBtn', 'onclick', logoutBtnHandler);
        safeAttach('pairForm', 'onsubmit', pairFormHandler);
        // Hide pairing form by default, show when addDeviceBtn is clicked
        var addDeviceBtn = document.getElementById('addDeviceBtn');
        if (addDeviceBtn) {
            addDeviceBtn.onclick = function() {
                const pairForm = document.getElementById('pairForm');
                if (pairForm && pairForm.style) pairForm.style.display = 'flex';
                const pairSuccess = document.getElementById('pairSuccess');
                if (pairSuccess) pairSuccess.textContent = '';
                const pairError = document.getElementById('pairError');
                if (pairError) pairError.textContent = '';
                const pairCode = document.getElementById('pairCode');
                if (pairCode) pairCode.value = '';
            };
        }
        // Always show login screen unless logged in
        if (getCookie('loggedIn') !== 'true') {
            if (document.getElementById('loginBox')) document.getElementById('loginBox').style.display = 'flex';
            if (document.getElementById('logoutBox')) document.getElementById('logoutBox').style.display = 'none';
            // Hide member dashboard sections
            const deviceListBox = document.getElementById('deviceListBox');
            if (deviceListBox && deviceListBox.style) deviceListBox.style.display = 'none';
            const remoteControlBox = document.getElementById('remoteControlBox');
            if (remoteControlBox && remoteControlBox.style) remoteControlBox.style.display = 'none';
            const pairForm = document.getElementById('pairForm');
            if (pairForm && pairForm.style) pairForm.style.display = 'none';
            return;
        }
        // If logged in, show correct dashboard
        const pairedDevices = getPairedDevices();
        let username = localStorage.getItem('lastLoginUser');
        if (username === 'admin') {
            window.location.href = 'admin.html';
            return;
        }
        if (document.getElementById('loginBox')) document.getElementById('loginBox').style.display = 'none';
        if (document.getElementById('logoutBox')) document.getElementById('logoutBox').style.display = 'flex';
        if (pairedDevices.length > 0) {
            const deviceListBox = document.getElementById('deviceListBox');
            if (deviceListBox && deviceListBox.style) deviceListBox.style.display = 'flex';
            populateDeviceSelector(pairedDevices);
            const remoteControlBox = document.getElementById('remoteControlBox');
            if (remoteControlBox && remoteControlBox.style) remoteControlBox.style.display = 'flex';
            joinDeviceRoom(pairedDevices[0].code);
            const pairForm = document.getElementById('pairForm');
            if (pairForm && pairForm.style) pairForm.style.display = 'none';
        } else {
            const pairForm = document.getElementById('pairForm');
            if (pairForm && pairForm.style) pairForm.style.display = 'flex';
            const deviceListBox = document.getElementById('deviceListBox');
            if (deviceListBox && deviceListBox.style) deviceListBox.style.display = 'none';
            const remoteControlBox = document.getElementById('remoteControlBox');
            if (remoteControlBox && remoteControlBox.style) remoteControlBox.style.display = 'none';
        }
    }
    // === CONFIGUREER HIER DE BACKEND API URL ===
    const BACKEND_API_URL = 'https://tracker-mobile-backend.onrender.com/api';

    // JWT helpers
    function setJwtToken(token) {
        localStorage.setItem('jwtToken', token || '');
    }
    function getJwtToken() {
        return localStorage.getItem('jwtToken') || '';
    }
    function eraseJwtToken() {
        localStorage.removeItem('jwtToken');
    }

    // ...member-only code...
    // ...existing code...
    // Utility: show loading spinner on buttons
    function setButtonLoading(btn, loading) {
        if (loading) {
            btn.disabled = true;
            btn.innerHTML = '<span class="material-icons" style="vertical-align:middle;margin-right:6px;">hourglass_top</span>Bezig...';
        } else {
            btn.disabled = false;
            btn.innerHTML = btn.getAttribute('data-label') || btn.textContent;
        }
    }
    let unlockCode = null;
    // Cookie helpers
    function setCookie(name, value, days) {
        let expires = "";
        if (days) {
            const date = new Date();
            date.setTime(date.getTime() + (days*24*60*60*1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "")  + expires + "; path=/";
    }
    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i=0;i < ca.length;i++) {
            let c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1,c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
        }
        return null;
    }
    function eraseCookie(name) {
        document.cookie = name+'=; Max-Age=-99999999; path=/';
    }

    // UI logic
    function showLogin() {
        document.getElementById('loginBox').style.display = 'flex';
        document.getElementById('logoutBox').style.display = 'none';
        // Do NOT clear paired devices on logout
    }
    function showLogout() {
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('logoutBox').style.display = 'flex';
    }

    // Multi-device helpers
    function getPairedDevices() {
        const json = localStorage.getItem('pairedDevices');
        return json ? JSON.parse(json) : [];
    }
    function setPairedDevices(devices) {
        localStorage.setItem('pairedDevices', JSON.stringify(devices));
    }


    // Event handler functions
    let pendingLogin = null;
    function loginFormHandler(e) {
        setButtonLoading(document.querySelector('#loginForm button'), true);
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        document.getElementById('errorMsg').textContent = '';
        if (username && password) {
            pendingLogin = { username, password };
            localStorage.setItem('lastLoginUser', username); // Save for dashboard routing
            // Check if 2FA is already set up for this user
            fetch(`${BACKEND_API_URL}/totp_2fa/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username })
            })
            .then(res => res.json())
            .then(data => {
                setButtonLoading(document.querySelector('#loginForm button'), false);
                if (data.success && data.has2fa) {
                    // 2FA is already set up, go straight to code input
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('totpSetupForm').style.display = 'none';
                    document.getElementById('totpForm').style.display = 'flex';
                } else if (data.success && data.qr) {
                    // 2FA not set up, show QR setup
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('totpSetupForm').style.display = 'flex';
                    document.getElementById('totpQrBox').innerHTML = `<img src='${data.qr}' style='max-width:180px;border-radius:8px;margin-bottom:8px;'><div style='color:#fff;font-size:0.95em;'>Scan deze QR met Google Authenticator</div>`;
                } else {
                    document.getElementById('errorMsg').textContent = 'Kon 2FA status niet ophalen.';
                }
            })
            .catch(err => {
                setButtonLoading(document.querySelector('#loginForm button'), false);
                document.getElementById('errorMsg').textContent = 'Serverfout: ' + err.message;
            });
        } else {
            setButtonLoading(document.querySelector('#loginForm button'), false);
            document.getElementById('errorMsg').textContent = 'Ongeldige gegevens';
        }
    }

    function totpSetupNextHandler(e) {
        document.getElementById('totpSetupForm').style.display = 'none';
        document.getElementById('totpForm').style.display = 'flex';
    }

    function totpFormHandler(e) {
        setButtonLoading(document.querySelector('#totpForm button'), true);
        e.preventDefault();
        const code = document.getElementById('totpCode').value;
        document.getElementById('totpError').textContent = '';
        if (!code || code.length !== 6) {
            document.getElementById('totpError').textContent = 'Voer een geldige 6-cijferige code in.';
            setButtonLoading(document.querySelector('#totpForm button'), false);
            return;
        }
        fetch(`${BACKEND_API_URL}/totp_2fa/verify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: pendingLogin.username, token: code })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                setButtonLoading(document.querySelector('#totpForm button'), false);
                setCookie('loggedIn', 'true', 7);
                document.getElementById('totpError').textContent = '';
                if (data.token) setJwtToken(data.token);
                // Redirect to admin dashboard if username is 'admin'
                if (pendingLogin.username === 'admin') {
                    window.location.href = 'admin.html';
                    return;
                }
                // Otherwise, show member dashboard
                showLogout();
                document.getElementById('pairForm').style.display = 'flex';
                document.getElementById('remoteControlBox').style.display = 'none';
                checkConnection();
                fetchAccounts();
            } else {
                setButtonLoading(document.querySelector('#totpForm button'), false);
                document.getElementById('totpError').textContent = 'Ongeldige code.';
            }
        })
        .catch(err => {
            setButtonLoading(document.querySelector('#totpForm button'), false);
            document.getElementById('totpError').textContent = 'Serverfout: ' + err.message;
        });
    }

    // ...member-only code...

    function deviceSelectorHandler(e) {
        const code = e.target.value;
        joinDeviceRoom(code);
    }

    function removeDeviceBtnHandler(e) {
        let pairedDevices = getPairedDevices();
        const selector = document.getElementById('deviceSelector');
        const idx = selector.selectedIndex;
        if (idx >= 0) {
            pairedDevices.splice(idx, 1);
            setPairedDevices(pairedDevices);
            populateDeviceSelector(pairedDevices);
            if (pairedDevices.length > 0) {
                joinDeviceRoom(pairedDevices[0].code);
            } else {
                document.getElementById('deviceListBox').style.display = 'none';
                document.getElementById('remoteControlBox').style.display = 'none';
                document.getElementById('pairForm').style.display = 'flex';
            }
        }
    }

    function logoutBtnHandler(e) {
        eraseCookie('loggedIn');
        eraseJwtToken();
        showLogin();
    }

    function pairFormHandler(e) {
        setButtonLoading(document.querySelector('#pairForm button'), true);
        e.preventDefault();
        const code = document.getElementById('pairCode').value;
        document.getElementById('pairSuccess').textContent = '';
        document.getElementById('pairError').textContent = '';
        if (!code || code.length !== 6) {
            document.getElementById('pairError').textContent = 'Voer een geldige 6-cijferige code in.';
            setButtonLoading(document.querySelector('#pairForm button'), false);
            return;
        }
        fetch(`${BACKEND_API_URL}/pair_device`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                setButtonLoading(document.querySelector('#pairForm button'), false);
                document.getElementById('pairSuccess').textContent = 'Toestel gekoppeld!';
                let pairedDevices = getPairedDevices();
                let name = prompt('Naam voor toestel?', 'Android ' + (pairedDevices.length + 1));
                pairedDevices.push({ code, name });
                setPairedDevices(pairedDevices);
                populateDeviceSelector(pairedDevices);
                document.getElementById('pairForm').style.display = 'none';
                document.getElementById('deviceListBox').style.display = 'flex';
                document.getElementById('remoteControlBox').style.display = 'flex';
                joinDeviceRoom(code);
                document.getElementById('unlockSection').style.display = 'none';
                document.getElementById('unlockCodeInput').value = '';
                document.getElementById('unlockCodeInput').placeholder = 'Ontgrendelcode';
            } else {
                setButtonLoading(document.querySelector('#pairForm button'), false);
                document.getElementById('pairError').textContent = data.error || 'Koppeling mislukt.';
            }
        })
        .catch(err => {
            setButtonLoading(document.querySelector('#pairForm button'), false);
            document.getElementById('pairError').textContent = 'Serverfout: ' + err.message;
        });
    }

    function populateDeviceSelector(devices) {
        const selector = document.getElementById('deviceSelector');
        selector.innerHTML = '';
        devices.forEach((dev, idx) => {
            const opt = document.createElement('option');
            opt.value = dev.code;
            opt.textContent = dev.name ? dev.name + ' (' + dev.code + ')' : dev.code;
            selector.appendChild(opt);
        });
    }

    // ...existing code...


    // Request permissions on app from website
    function requestPermissionsOnApp() {
        if (socket) socket.emit('request-permissions');
    }

    // Remote control knoppen
    document.getElementById('lockBtn').onclick = function() {
        if (unlockCode) return; // Prevent double lock
        unlockCode = Math.floor(100000 + Math.random() * 900000).toString();
        if (socket) socket.emit('lock-device', unlockCode);
        document.getElementById('unlockSection').style.display = 'flex';
        document.getElementById('wipeBtn').style.display = 'inline-block';
        document.getElementById('screenshotBtn').style.display = 'inline-block';
        document.getElementById('unlockCodeInput').placeholder = 'Code: ' + unlockCode;
    };
    document.getElementById('unlockBtn').onclick = function() {
        const code = document.getElementById('unlockCodeInput').value;
        if (socket && code) socket.emit('unlock-device', code);
        // Reset UI after unlock
        unlockCode = null;
        document.getElementById('unlockSection').style.display = 'none';
        document.getElementById('wipeBtn').style.display = 'none';
        document.getElementById('screenshotBtn').style.display = 'none';
        document.getElementById('unlockCodeInput').value = '';
        document.getElementById('unlockCodeInput').placeholder = 'Ontgrendelcode';
    };
    document.getElementById('wipeBtn').onclick = function() {
        if (socket) socket.emit('wipe-device');
    };
    document.getElementById('screenshotBtn').onclick = function() {
        if (socket) socket.emit('request-screenshot');
    };

    // Check backend connection
    async function checkConnection() {
        try {
            const res = await fetch(`${BACKEND_API_URL}/check_connection`);
            const data = await res.json();
            if (data.connected) {
                document.getElementById('connectionStatus').textContent = 'Backend verbinding OK.';
            } else {
                document.getElementById('connectionStatus').textContent = 'Backend niet bereikbaar.';
            }
        } catch (err) {
            document.getElementById('connectionStatus').textContent = 'Backend niet bereikbaar.';
        }
    }
    </script>
</body>
</html>

